- name: "ensure helm repository key is present"
  become: yes
  ansible.builtin.apt_key:
    id: 81BF832E2F19CD2AA0471959294AC4827C1A168A
    url: https://baltocdn.com/helm/signing.asc
    state: present
- name: "ensure kubectl repository key is present"
  become: yes
  ansible.builtin.apt_key:
    id: "A362B822F6DEDC652817EA46B53DC80D13EDEF05"
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present
- name: "ensure helm repository is present"
  become: yes
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://baltocdn.com/helm/stable/debian/ all main"
    state: present
- name: "ensure kubectl repository is present"
  become: yes
  ansible.builtin.apt_repository:
    repo: "deb http://packages.cloud.google.com/apt/ kubernetes-xenial main"
    state: present
- name: "ensure helm package is installed"
  become: yes
  apt:
    name: helm
    state: present
- name: "ensure kubectl package is installed"
  become: yes
  apt:
    name: kubectl
    state: present
- name: Ensure openshift python package exists
  pip:
    name:
      - openshift
- name: Ensure Calico Helm Repository exists
  kubernetes.core.helm_repository:
    name: "projectcalico"
    repo_url: "https://projectcalico.docs.tigera.io/charts"
- name: Ensure CertManager Helm Repository exists
  kubernetes.core.helm_repository:
    name: "jetstack"
    repo_url: "https://charts.jetstack.io"
- name: Ensure Bitnami Helm Repository exists
  kubernetes.core.helm_repository:
    name: "bitnami"
    repo_url: "https://charts.bitnami.com/bitnami"
- name: Ensure Tigera Operator is installed
  kubernetes.core.helm:
    name: tigera-operator
    namespace: tigera-operator
    create_namespace: true
    chart_ref: projectcalico/tigera-operator
    chart_version: v3.24.5
- name: Ensure Calico Installation is present
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('ansible.builtin.file', 'templates/calico-installation.yaml') | from_yaml }}"
  register: calico_installation
- name: Ensure coredns is restarted
  shell: "kubectl rollout restart --namespace kube-system deployment/coredns"
  when: calico_installation.changed
- name: Ensure metallb is installed
  kubernetes.core.helm:
    name: metallb
    namespace: metallb-system
    create_namespace: true
    chart_ref: bitnami/metallb
    chart_version: 4.1.13
- name: Wait 60s for metallb to startup
  wait_for:
    timeout: 60
- name: Ensure metallb ipaddresspool is installed
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('ansible.builtin.file', 'templates/metallb-ipaddresspool.yaml') | from_yaml }}"
- name: Ensure metallb l2advertisement is installed
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('ansible.builtin.file', 'templates/metallb-l2advertisement.yaml') | from_yaml }}"
